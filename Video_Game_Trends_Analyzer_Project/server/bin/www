#!/usr/bin/env node
import app from "../app.js"
import { db } from '../db/db.js';
import process from 'node:process';

const port = process.env.PORT || 3000;

try{
    // await db.connect("Video_Game_Trends_Analyzer_Production");
    await db.connect(process.env.DB);
    await db.setCollection(process.env.VG_COLLECTION);
    //check db collection is not empty
    const count = await db.collection.countDocuments();
    
    if(count === 0){
        console.log('Database collection is empty, aborting')
        process.exit(1)
    }

    //start listening after DB is connected
    const server = app.listen(port, () => {
        console.log('Server listening on port 3000!');
    });
    //shut down server gracefully
    process.on('SIGINT', () => {
      console.debug('SIGINT signal received: closing HTTP server');
      server.close(() => {
        console.debug('HTTP server closed');
        process.exit(0);
      });
    });
} catch (error){
    console.error('Failed to start server:', error)
    process.exit(1);
}
